from __future__ import annotations

from flask import Flask, request, jsonify
from flask_cors import CORS
import pandas as pd
import joblib
import numpy as np
import os

# ---------- NEW: OpenAI import ----------
from openai import OpenAI
# HARD-CODED OPENAI API KEY (Prototype)
HARDCODED_OPENAI_API_KEY = ""
app = Flask(__name__)
CORS(app)  # Enable CORS for frontend

# Compute module root (same as training for consistency)
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../../'))

# Load model and preprocessors (from /models)
models_dir = os.path.join(project_root, 'models')  # backend/models/
model = joblib.load(os.path.join(models_dir, 'stroke_model.pkl'))
label_encoders = joblib.load(os.path.join(models_dir, 'label_encoders.pkl'))
imputer = joblib.load(os.path.join(models_dir, 'imputer.pkl'))

categorical_cols = ['gender', 'ever_married', 'work_type', 'Residence_type', 'smoking_status']


def build_stroke_prompt(prob, data):
    """
    Build a prompt for OpenAI based on stroke probability and user data.
    This is a prototype: high-level lifestyle guidance, NOT a diagnosis.
    """
    # Keep only some safe, high-level details for the prompt
    age = data.get("age")
    hypertension = data.get("hypertension")
    heart_disease = data.get("heart_disease")
    smoking_status = data.get("smoking_status")
    avg_glucose_level = data.get("avg_glucose_level")
    bmi = data.get("bmi")

    user_context = (
        f"Age: {age}, "
        f"Hypertension: {hypertension}, "
        f"Heart disease: {heart_disease}, "
        f"Smoking status: {smoking_status}, "
        f"Average glucose level: {avg_glucose_level}, "
        f"BMI: {bmi}"
    )

    prompt = f"""
You are a careful, conservative medical assistant. 
You are not a doctor and this is NOT a diagnosis, only general educational information.

A stroke risk prediction model has estimated the probability of stroke as {prob:.3f} (0 = low, 1 = high).
Patient context (non-identifying, approximate): {user_context}.

In 3 short sections, give **simple, actionable, layman-friendly** advice:

1) IMMEDIATE PREVENTIVE MEASURES (today & this week):
- 3–5 bullet points on what the person can start doing right now (sleep, diet, hydration, avoiding smoking/alcohol, basic BP/sugar monitoring, stress control, etc.).

2) LIGHT, SAFE EXERCISES:
- 3–5 examples of light exercises suitable for most beginners (like brisk walking, gentle stretching, simple breathing exercises).
- Mention approximate duration and frequency (e.g., 20–30 minutes, 5 days/week).
- Emphasize: stop if they feel chest pain, severe shortness of breath, dizziness, or any alarming symptoms.

3) MEDICAL FOLLOW-UP & WARNING SIGNS:
- 2–4 bullet points telling them to consult a qualified doctor for personalized advice and testing.
- Briefly mention classic stroke warning signs (like FAST: Face drooping, Arm weakness, Speech difficulty, Time to call emergency).
- Strongly remind: if they have sudden weakness, trouble speaking, severe headache, or vision issues, they must seek emergency care immediately.

Keep the tone calm, encouraging, and easy to understand.
Do NOT mention that this was generated by AI or a model; talk directly to the user.
    """.strip()

    return prompt


def get_openai_client(api_key: str | None):
    """
    Create an OpenAI client if api_key is provided, else return None.
    """
    if not api_key:
        return None
    return OpenAI(api_key=api_key)


def get_stroke_recommendation(prob, original_request_data, api_key: str | None):
    """
    Call OpenAI to get a lifestyle/exercise recommendation.
    If no API key is provided or an error occurs, return a safe fallback message.
    """
    # If you don't want to hard-fail when key is missing, return a generic message
    if not api_key:
        return (
            "This is a prototype and no OpenAI API key was provided. "
            "General advice: maintain a healthy weight, avoid smoking and excess alcohol, "
            "eat a balanced diet low in salt and sugar, stay physically active with light daily exercise, "
            "and regularly consult a doctor to monitor blood pressure, sugar, and cholesterol."
        )

    client = get_openai_client(api_key)

    try:
        prompt = build_stroke_prompt(prob, original_request_data)

        response = client.chat.completions.create(
            model="gpt-4.1-mini",  # or any other deployed model you prefer
            messages=[
                {
                    "role": "system",
                    "content": (
                        "You are a cautious medical information assistant. "
                        "You provide general health and lifestyle guidance only, "
                        "never a diagnosis. You always recommend consulting a doctor for "
                        "personalized medical advice or emergencies."
                    ),
                },
                {"role": "user", "content": prompt},
            ],
            max_tokens=500,
            temperature=0.4,
        )

        recommendation = response.choices[0].message.content.strip()
        return recommendation

    except Exception as e:
        # Fallback in case OpenAI call fails
        print("Error while calling OpenAI:", str(e))
        return (
            "We were unable to generate a detailed recommendation at this moment. "
            "As a general guideline, focus on: not smoking, limiting alcohol, "
            "keeping blood pressure, sugar, and cholesterol under control, "
            "walking or doing light activity most days of the week, eating more "
            "fruits and vegetables, and following up with a qualified doctor "
            "for personalized stroke prevention advice."
        )


@app.route('/predict', methods=['POST'])
def predict_stroke():
    try:
        data = request.get_json()
        print("Received data for prediction:", data)

        # Validate required fields
        required_fields = [
            'gender', 'age', 'hypertension', 'heart_disease', 'ever_married',
            'work_type', 'Residence_type', 'avg_glucose_level', 'bmi', 'smoking_status'
        ]
        if not all(field in data for field in required_fields):
            return jsonify({"error": "Missing required fields"}), 400

        # Prepare input (copy, so we still have original for prompt)
        input_data = data.copy()

        # Encode categoricals
        for col in categorical_cols:
            if col in input_data:
                encoded_value = label_encoders[col].transform([input_data[col]])[0]
                input_data[col] = encoded_value

        # Impute BMI if NaN
        if pd.isna(input_data.get('bmi', np.nan)):
            input_data['bmi'] = imputer.transform([[np.nan]])[0][0]

        # Create DataFrame
        input_df = pd.DataFrame([input_data])

        # Predict prob of stroke (class 1)
        prob = model.predict_proba(input_df)[0][1]

        # -------- NEW: OpenAI recommendation integration --------
        # Priority: API key from header (for prototype), else from environment
        # openai_api_key = request.headers.get('X-OpenAI-Key') or os.getenv('OPENAI_API_KEY')

        recommendation = get_stroke_recommendation(
            prob=prob,
            original_request_data=data,  # use unencoded input for user-friendly context
            api_key=HARDCODED_OPENAI_API_KEY
        )

        # JSON response with both fields
        return jsonify({
            "stroke_prob": float(prob),
            "recommendation": recommendation
        })

    except Exception as e:
        print("Error during prediction:", str(e))
        return jsonify({"error": str(e)}), 500


if __name__ == '__main__':
    # Make sure OPENAI_API_KEY is set in your environment for default usage
    # or send 'X-OpenAI-Key' header from the frontend.
    app.run(debug=True, host='0.0.0.0', port=5000)
